第四章基于TCP协议的文件传输系统
一、基础知识的学习
1、掌握计算机网络的基础知识（基本常识）
2、掌握socket的常用函数，能编写最简单的网咯通信程序
二、封装socket的API
1、解决TCP报文粘包/分包的问题
（1）粘包：两个报文粘在一起（组合小的报文）
发送方发送两个字符串“hello”和“world”,接收方却一次性收到了“helloworld”。
①要发送的数据小于TCP发送缓冲区的大小，TCP将多次写入缓冲区的数据一次发送出 去，将会发生粘包。
②接收数据端的应用层没有及时读取接收缓冲区中的数据，将发生粘包。
（2）分包：一个报文被分成两个报文发送（拆分大的报文）
 发送方发送一个字符串“helloworld”，“hello”和“world”,接收方却收到了两个字符串“hello”和“world”。
①要发送的数据大于TCP发送缓冲区剩余空间大小，将会发生分包。
②待发送数据大于MSS（最大报文长度），TCP在传输前将进行分包。
（3）TCP协议的保证：
①报文内容的顺序不变，如果对方发送“hello”，接收方也一定顺序接受到“hello”
②分割的包中间不会插入其他数据
（4）解决TCP粘包、分包问题
①采用自定的报文格式
在报文的首部中加入报文长度字段（报文长度可用ASCII码表示，也可用二进制码表示-----实际开发中常用）
（5）网络字节序与主机字节序
①字节序：字节序是指多字节数据在计算机内存中存储顺序，或者网络传输时各字节的传输顺序，字节序分为大端序和小端序。
大端序：高字节存储在低位地址，传输数据时高位在前；
小端序：低字节存储在低位地址，传输数据时高位在后；
②网络字节序：网络字节序是TCP/IP中规定好的一种数据表示格式，它与具体的CPU类型、操作系统等无关，从而可以保证数据在不同主机之间传输时能够被正确解释。网络字节序采用big endian排序方式。
③主机字节序：自己的主机内部，内存中数据的处理方式

2、封装socket的常用函数
三、多进程的网络服务端
1、搭建多进程的网络服务端框架：实现多个客户端与服务端的通信
（1）Linux多进程：通过调用fork()函数，实现由父进程创建子进程
  ①子进程返回0，父进程返回子进程的ID
②子进程是父进程的副本
③子进程获得了父进程的数据空间、堆和栈的副本，不是共享---->子进程或父进程关闭自己的文件描述否后不会互相影响
启动程序---->查看程序对应的进程编号（父进程，子进程-->子进程的父进程编号为父进程）---->在根目录的proc文件夹下查看对应进程编号下的fd文件夹，里面存放的是该进程的文件描述符（0--标准输入，1-----标准输出，2----标准错误，监听，连接）
（2）进程的退出
①向服务端发出“Ctrl+c”信号，父进程和子进程均退出，且显示两个退出信号（原因：信号处理函数在执行的过程中又收到的信号------>解决办法：在信号处理函数中忽略掉收到的而其他信号）

（3）客户端与服务端的通信
①请求报文：可以由客户端发起，也可以由服务端发起
②请求报文与回应报文之间的关系：一对一、多对多
2、TCP短连接、长连接和心跳机制
（1）短连接：是相对于长连接而言的概念，指的是在数据传送过程中，只在需要发送数据时才去建立一个连接，数据发送完成后则断开此连接，即每次连接只完成一项业务的发送。（建立连接后马上通信，通信结束后，连接断开）
过程：连接（客户端请求->服务端响应）->传输数据->关闭连接。下次一次需要传输数据需要再次连接。
应用场景：而像WEB网站的http服务一般都用短链接，因为长连接对于服务端来说会耗费一定的资源，而像WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源，如果用长连接，而且同时有成千上万的用户，如果每个用户都占用一个连接的话，那可想而知吧。
所以并发量大，但每个用户无需频繁操作情况下需用短连好。

（2）长连接：指在一个连接上可以连续发送多个数据包，在连接保持期间，如果没有数据包发送，需要双方发链路检测包（通信的次数和间隔是不定的）。
过程：连接（客户端请求->服务端响应）->传输数据->保持连接 -> 传输数据-> …->直到一方关闭连接，客户端关闭连接。长连接指建立SOCKET连接后无论使用与否都要保持连接。
应用场景：长连接多用于操作频繁，点对点的通讯，而且连接数不能太多情况。每个TCP连接都需要三步握手，这需要时间，如果每个操作都是先连接，再操作的话那么处理速度会降低很多，所以每个操作完后都不断开，次处理时直接发送数据包就OK了，不用新建立TCP连接。

例如：数据库的连接用长连接， 如果用短连接频繁的通信会造成socket错误，而且频繁的socket 创建也是对资源的浪费。
（3）示意图

（4）心跳机制管理TCP的长连接
①服务端与客户端约定通信的超时时间，假设为35秒
②如果服务端在超时时间内（35秒）没有收到客户端的任何报文，则认为客户端发生了异常。服务端主动关闭与客户端的连接。
③如果客户端在超时时间内（35秒）没有发生人和业务，就应该向服务端发送心跳报文。（证明客户端未发生异常）
（5）心跳报文
发送：<srvcode>0</srvcode>
回应：<retcode>0</retcode><message>成功。</message>
（6）应用经验
①在同一网段内部（局域网），网络设备不会断开空闲的连接。
②在不同网段之间，网络设备肯定会断开TCP连接，超时时间不定，一般为1~5分钟。
③网路服务程序心跳的超时时间一般设置在50~120秒之间。
四、开发基于TCP协议额文件传输系统（用于系统内部，对文件传输的时效性要求比较高）
1、实现文件的上传和下载功能
（1）TCP连接由客户端发起，登录协商文件传输的参数
（2）上传：由客户端发起文件传输请求，把客户端目录中的文件发送给服务端
（3）下载：由服务端发起文件传输请求，把服务端目录的文件发送给客户端
2、采用异步通信机制，实现文件的快速传输
同步通信：一问一答，没有回应时等待
异步通信：无需等待
（1）异步通信的实现
①多进程：用不同的进程发送报文和接收报文
②多线程：用不同的线程发送报文和接收报文
③I/O复用：采用select、poll、epoll函数
3、模块
（1）文件传输的服务端模块（支持上传和下载）
（2）文件上传的客户端模块
①流程：登录（与服务端建立连接）---->获取本地目录中的文件清单------>把文件信息发送给服务端------>把文件内容发送给服务端-------->接收服务端的确认报文------->全部的文件被发送完成 
②注意事项：
ⅰ客户端程序常驻内存，每间隔几秒执行一次传输任务
ⅱ文件传输成功后，删除本地文件或转存到备份目录（不需要增量传输）
（3）文件下载的客户端模块
五、总结
1、主要知识点
（1）计算机网络基础知识
（2）封装socket的API
（3）多进程网络服务端
（4）文件上传和下载功能的实现
2、异步通信
滑动窗口限流、重发机制
